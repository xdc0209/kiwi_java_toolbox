# Windows下Java程序内存泄露的定位

## 概述

堆内内存的泄露问题，不管是Linux或是Windows，使用Java自带的一些工具即可解决。  
堆外内存的泄露问题，需要借助相关系统的工具进行分析，本文主要讲下Windows中基本工具的用法。  

## 工具介绍

1. 设置任务管理器中"进程"选项卡的显示列，把内存泄露相关的列都选上。  

   界面导航：任务管理器--"进程"选项卡--标题栏--查看--选择列  
   设置列：PID、用户名、CPU使用率、内存-工作集、内存-专用工作集、内存-提交大小、内存-非页面缓冲池、句柄数、线程数、命令行、描述。  

   含义解释：  

   - 内存-专用工作集(WS Private)：进程独占的物理内存(重要)。  
   - 内存-共享工作集(WS Share)：进程与别的进程共享的内存量，一般占不大。  
   - 内存-工作集(Working Set)：进程所占用的总物理内存，是专用工作集、共享工作集之和(重要，也就是平时所说的一个进程占了多少内存)。  
   - 内存-提交大小(Private Bytes或Commit Size)：专用工作集 + 保存在页面文件中的独占内存，页面文件是什么：是虚拟内存使用的文件，不存放在物理内存中的内存，文件路径一般在C:\pagefile.sys。  
   - 非页面缓冲池：Windows NT把内核模式地址空间分成分页内存池和非分页内存池。(用户模式地址空间总是分页的) 必须驻留的代码和数据放在非分页池；不必常驻的代码和数据放在分页池中。Windows NT为决定代码和数据是否需要驻留非分页池提供了一个简单规则。非分页内容的空间是很小的，所以一般的东西都会放入分页内存中。  
   - 句柄数：打开文件和网络等资源的句柄总数。  
   - 线程数：宝贵的线程数，不可忽略。  
   - 命令行：查看进程的参数。  

   提示关注点：  

   - 关注内存即关注内存-工作集。  
   - 提交大小或非页面缓冲池不断上涨需关注内存泄露。  
   - 线程数不断上涨需关注线程泄露。关注jvisualvm中看到的线程个数大小。jvisualvm和任务管理器中线程个数的差值。  

2. 使用Process Explorer(增强版的任务管理器)。  
   参见：<http://www.cr173.com/html/18315_all.html>  

## 案例

Java中使用C的类库，此类库存在Bug，不断的创建线程，导致内存持续上涨。发现问题原因的线索是在JVM中看到的线程数量才200多，但在任务管理区中线程数量达到了2500多，再在Process Explorer中的线程页面(右键进程--属性--线程)，发现了出现增长(在Process Explorer界面标红显示)的线程名称，至此问题基本找到根因，剩下的是分析有问题的代码逻辑。  
